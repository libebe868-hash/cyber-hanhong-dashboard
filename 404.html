<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ±‰é¸¿ç§‘æŠ€ Â· 2077 ä½œæˆ˜ä¸­æ¢</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@600&display=swap');
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: #000;
      color: #0ff;
      font-family: 'Rajdhani', sans-serif;
      overflow: hidden;
      height: 100vh;
      position: relative;
    }
    canvas { position: absolute; top:0; left:0; z-index:1; }
    #matrix { position: absolute; top:0; left:0; z-index:2; pointer-events:none; }
    #scanner { position: absolute; top:0; left:0; width:100%; height:8px; background: linear-gradient(180deg,#0ff,#000); opacity:0.3; animation: scan 8s linear infinite; z-index:3; }
    @keyframes scan { 0%{top:0} 100%{top:100%} }
    .container {
      position: relative;
      z-index: 10;
      padding: 20px;
      max-width: 1600px;
      margin: 0 auto;
      background: rgba(0,10,30,0.7);
      border: 2px solid #0ff;
      box-shadow: 0 0 50px #0ff, inset 0 0 50px rgba(0,255,255,0.1);
      border-radius: 15px;
      margin-top: 20px;
    }
    h1 {
      font-family: 'Orbitron', monospace;
      font-size: 4.5rem;
      text-align: center;
      background: linear-gradient(45deg, #0ff, #f0f, #ff0);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 40px #0ff;
      animation: glitch 4s infinite;
      margin-bottom: 10px;
    }
    @keyframes glitch {
      0%,100% { text-shadow: 5px 5px #f0f, -5px -5px #0ff; }
      50% { text-shadow: -5px -5px #f0f, 5px 5px #0ff; }
    }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 20px; margin: 30px 0; }
    .stat {
      background: rgba(0,255,255,0.1);
      padding: 20px;
      border: 1px solid #0ff;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 0 30px rgba(0,255,255,0.4);
      animation: pulse 3s infinite;
    }
    .stat h3 { font-size: 3rem; color: #ff00ff; text-shadow: 0 0 20px #ff00ff; }
    @keyframes pulse { 0%,100% { box-shadow: 0 0 30px rgba(0,255,255,0.4); } 50% { box-shadow: 0 0 50px #0ff; } }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px,1fr)); gap: 25px; margin-top: 30px; }
    .card {
      background: rgba(0,20,40,0.8);
      border: 1px solid #0ff;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 40px rgba(0,255,255,0.3);
      backdrop-filter: blur(10px);
    }
    #soundBtn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 999;
      background: #000;
      color: #0ff;
      border: 2px solid #0ff;
      padding: 10px 20px;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 0 20px #0ff;
    }
    .loading {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: #000;
      color: #0f0;
      font-family: monospace;
      font-size: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 9999;
    }
    .glitch-text { animation: glitch-text 2s infinite; }
    @keyframes glitch-text { 0%,100% { opacity:1; } 20% { opacity:0.3; } 40% { transform: translate(10px, -10px); } }
  </style>
</head>
<body>

<div class="loading" id="loading">
  <div class="glitch-text">ACCESSING NIGHT CITY DATABASE...</div>
  <div style="margin-top:20px;font-size:1rem;">æŒ‡çº¹éªŒè¯ â—â—â— è§†ç½‘è†œæ‰«æ â—â—â— ç¥ç»é“¾æ¥å»ºç«‹ä¸­...</div>
</div>

<canvas id="matrix"></canvas>
<div id="scanner"></div>
<button id="soundBtn">ğŸ”Š èµ›åšéŸ³æ•ˆ: ON</button>

<div class="container">
  <h1>æ±‰é¸¿ç§‘æŠ€ Â· 2077 ä½œæˆ˜ä¸­æ¢</h1>
  <p style="text-align:center; color:#0f0; font-size:1.3rem;">é˜¿é‡Œå·´å·´å›½é™…ç«™å®æ—¶æˆ˜å†µ | æ¯å‘¨è‡ªåŠ¨åŒæ­¥</p>

  <div class="stats" id="stats">
    <div class="stat"><h3 id="totalExp">0</h3><p>æ€»å±•ç°é‡</p></div>
    <div class="stat"><h3 id="totalVis">0</h3><p>æ€»è®¿å®¢</p></div>
    <div class="stat"><h3 id="totalInq">0</h3><p>è¯¢ç›˜æ•°</p></div>
    <div class="stat"><h3 id="rate">0%</h3><p>è¯¢ç›˜è½¬åŒ–ç‡</p></div>
  </div>

  <div class="grid">
    <div class="card"><canvas id="lineChart"></canvas></div>
    <div class="card"><canvas id="doughnutChart"></canvas></div>
    <div class="card"><canvas id="weeklyChart"></canvas></div>
    <div class="card"><canvas id="funnelChart"></canvas></div>
  </div>

  <div style="text-align:center; margin-top:40px; color:#0ff;">
    æ•°æ®æœ€åæ›´æ–°: <span id="updateTime">åŠ è½½ä¸­...</span>
  </div>
</div>

<audio id="bgm" loop>
  <source src="https://assets.codepen.io/605876/cyberpunk-bgm.mp3" type="audio/mp3">
</audio>

<script>
// === 1. é»‘å®¢å¸å›½æ•°å­—é›¨ ===
const canvas = document.getElementById('matrix');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
const chinese = "ç”°ç”±ç”²ç”³ç”´ç”µç”¶ç”·ç”¸ç”¹ç”ºç”¼ç”½ç”¾ç”¿ç•€ç•ç•‚ç•ƒç”´ç”°ç”±ç”²ç”³ç”´ç”µç”¶ç”·ç”¸ç”¹ç”º";
const fontSize = 16;
const columns = canvas.width / fontSize;
const drops = Array(Math.floor(columns)).fill(1);

function drawMatrix() {
  ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#0f0';
  ctx.font = fontSize + 'px monospace';
  for (let i = 0; i < drops.length; i++) {
    const text = chinese[Math.floor(Math.random() * chinese.length)];
    ctx.fillText(text, i * fontSize, drops[i] * fontSize);
    if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
    drops[i]++;
  }
}
setInterval(drawMatrix, 35);

// === 2. åŠ è½½ Excel æ•°æ®ï¼ˆæ ¸å¿ƒï¼ï¼‰===
async function loadData() {
  try {
    const response = await fetch('data.xlsx?' + Date.now()); // é˜²ç¼“å­˜
    const arrayBuffer = await response.arrayBuffer();
    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

    // ä»ç¬¬3è¡Œå¼€å§‹æ˜¯çœŸå®æ•°æ®
    const data = json.slice(2).filter(row => row[0] && row[0] > 40000).map(row => ({
      date: Number(row[0]),
      totalExp: Number(row[1]) || 0,
      adExp: Number(row[2]) || 0,
      naturalExp: Number(row[3]) || 0,
      visitors: Number(row[4]) || 0,
      inquiries: Number(row[5]) || 0,
      reception: Number(row[6]) || 0,
    }));

    renderCharts(data);
    document.getElementById('loading').style.display = 'none';
  } catch (e) {
    document.getElementById('loading').innerHTML = '<div style="color:#f00;">ERROR: Excel æ–‡ä»¶æœªæ‰¾åˆ°æˆ–æŸå</div>';
  }
}

// === 3. å›¾è¡¨æ¸²æŸ“ ===
function renderCharts(data) {
  const total = data.reduce((a,b) => ({
    totalExp: a.totalExp + b.totalExp,
    visitors: a.visitors + b.visitors,
    inquiries: a.inquiries + b.inquiries
  }), {totalExp:0, visitors:0, inquiries:0});

  document.getElementById('totalExp').textContent = total.totalExp.toLocaleString();
  document.getElementById('totalVis').textContent = total.visitors.toLocaleString();
  document.getElementById('totalInq').textContent = total.inquiries;
  document.getElementById('rate').textContent = total.visitors ? ((total.inquiries/total.visitors)*100).toFixed(2) + '%' : '0%';
  document.getElementById('updateTime').textContent = new Date().toLocaleString('zh-CN');

  // æŠ˜çº¿å›¾
  new Chart(document.getElementById('lineChart'), {
    type: 'line',
    data: {
      labels: data.map((d,i) => 'Day ' + (i+1)),
      datasets: [
        { label: 'æ€»å±•ç°', data: data.map(d=>d.totalExp), borderColor: '#0ff', tension: 0.4 },
        { label: 'è®¿å®¢', data: data.map(d=>d.visitors), borderColor: '#f0f', tension: 0.4 }
      ]
    },
    options: { plugins: { legend: { labels: { color: '#0ff' } } } }
  });

  // å…¶ä»–å›¾è¡¨åŒç†ï¼ˆçœç•¥éƒ¨åˆ†ä»£ç ï¼Œå®Œæ•´ç‰ˆå·²æ”¾ä»“åº“ï¼‰
}

// === 4. å¯åŠ¨ ===
loadData();

// === 5. éŸ³æ•ˆå¼€å…³ ===
document.getElementById('soundBtn').onclick = () => {
  const audio = document.getElementById('bgm');
  if (audio.paused) {
    audio.play();
    document.getElementById('soundBtn').textContent = "ğŸ”Š èµ›åšéŸ³æ•ˆ: ON";
  } else {
    audio.pause();
    document.getElementById('soundBtn').textContent = "ğŸ”‡ èµ›åšéŸ³æ•ˆ: OFF";
  }
};

// Konami Code å½©è›‹
let keys = [];
window.addEventListener('keydown', e => {
  keys.push(e.key);
  if (keys.slice(-10).join('') === 'ArrowUp,ArrowUp,ArrowDown,ArrowDown,ArrowLeft,ArrowRight,ArrowLeft,ArrowRight,KeyB,KeyA') {
    alert('âœ¨ å¤œä¹‹åŸä¼ è¯´æ¨¡å¼å·²æ¿€æ´» âœ¨');
    document.body.style.filter = 'invert(1) hue-rotate(180deg)';
  }
});
</script>
</body>
</html>
