<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>汉鸿店铺 · 霓虹战情室 Pro</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- 必须引入这个插件才能在图表上显示数值 -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Rajdhani:wght@500;700&display=swap');
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      color: #fff;
      font-family: 'Rajdhani', sans-serif;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }
    .stars { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; 
      background: radial-gradient(2px 2px at 20px 30px, #eee, transparent), radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent);
      background-repeat: repeat; background-size: 200px 100px;
      animation: twinkle 8s linear infinite; 
    }
    @keyframes twinkle { 0% { transform: translate(0,0) rotate(0deg); } 100% { transform: translate(50px,50px) rotate(360deg); } }
    .glow-line { position: absolute; top: 80px; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #00ffff, transparent); box-shadow: 0 0 20px #00ffff; animation: flow 6s linear infinite; z-index: 2; }
    @keyframes flow { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }

    header { text-align: center; padding: 30px 20px; position: relative; z-index: 10; }
    h1 {
      font-family: 'Orbitron', monospace;
      font-size: 4.5rem;
      background: linear-gradient(45deg, #ff00ff, #00ffff, #ff00ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 0 40px rgba(0,255,255,0.8);
      animation: neon 3s infinite alternate;
    }
    @keyframes neon { from { filter: brightness(1); } to { filter: brightness(1.5); } }

    .month-selector { text-align: center; margin: 20px 0; z-index: 10; }
    .month-select {
      background: rgba(255,0,255,0.2);
      border: 1px solid #ff00ff;
      color: #ff00ff;
      padding: 12px 30px;
      border-radius: 30px;
      font-size: 1.1rem;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(255,0,255,0.4);
      transition: all 0.3s;
    }
    .month-select:hover { background: #ff00ff; color: #000; box-shadow: 0 0 25px #ff00ff; }

    .container { max-width: 1600px; margin: 0 auto; padding: 20px; position: relative; z-index: 10; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin: 30px 0; }
    .stat-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid #00ffff;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0,255,255,0.2);
      transition: all 0.4s;
    }
    .stat-card:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(0,255,255,0.4); }
    .stat-card h3 { font-size: 2.8rem; color: #ff00ff; text-shadow: 0 0 20px #ff00ff; }
    .stat-card p { color: #00ffff; }

    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 25px; margin-top: 30px; }
    .chart-card {
      background: rgba(0,0,0,0.4);
      border: 2px solid #00ffff;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 30px rgba(0,255,255,0.3);
      backdrop-filter: blur(10px);
      position: relative;
      animation: pulse-border 3s infinite;
    }
    @keyframes pulse-border { 0%,100% { box-shadow: 0 0 30px rgba(0,255,255,0.3); } 50% { box-shadow: 0 0 50px rgba(0,255,255,0.7); } }

    .chart-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 2.8rem; font-weight: bold; text-shadow: 0 0 20px; pointer-events: none; z-index: 10; }

    footer { text-align: center; padding: 40px; color: #00ffff; font-size: 1.1rem; margin-top: 50px; }
    .update { color: #ff00ff; animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100% { opacity: 0.7; } 50% { opacity: 1; } }
  </style>
</head>
<body>
  <div class="stars"></div>
  <div class="glow-line"></div>

  <header>
    <h1>汉鸿店铺 · 霓虹战情室 Pro</h1>
    <p style="color:#00ffff;font-size:1.4rem;">阿里巴巴国际站实时作战看板 · 全图表数值显示</p>
  </header>

  <div class="month-selector">
    <select class="month-select" id="monthSelect"></select>
  </div>

  <div class="container">
    <div class="stats">
      <div class="stat-card"><h3 id="totalExp">0</h3><p>总展现量</p></div>
      <div class="stat-card"><h3 id="totalVis">0</h3><p>总访客数</p></div>
      <div class="stat-card"><h3 id="totalInq">0</h3><p>询盘总数</p></div>
      <div class="stat-card"><h3 id="totalRec">0</h3><p>接待总数</p></div>
      <div class="stat-card"><h3 id="convRate">0%</h3><p>询盘转化率</p></div>
      <div class="stat-card"><h3 id="adRate">0%</h3><p>广告占比</p></div>
    </div>

    <div class="charts-grid">
      <!-- 1. 广告占比 -->
      <div class="chart-card">
        <h3>广告 vs 自然流量占比</h3>
        <canvas id="pieChart"></canvas>
        <div class="chart-center" id="pieCenter" style="color:#ff00ff">92.8%</div>
      </div>

      <!-- 2. 周询盘&接待 -->
      <div class="chart-card">
        <h3>周询盘 & 周接待人数趋势</h3>
        <canvas id="weeklyChart"></canvas>
        <div class="chart-center" style="color:#00ffff;font-size:2.2rem" id="weeklyTotal">51</div>
      </div>

      <!-- 3. 月度询盘总量 -->
      <div class="chart-card">
        <h3>月度询盘总量</h3>
        <canvas id="monthlyChart"></canvas>
      </div>

      <!-- 4. 每日增长热力图 -->
      <div class="chart-card">
        <h3>每日询盘增长热力图</h3>
        <canvas id="heatmapChart"></canvas>
      </div>

      <!-- 5. 漏斗 -->
      <div class="chart-card">
        <h3>询盘转化漏斗</h3>
        <canvas id="funnelChart"></canvas>
      </div>

      <!-- 6. 全期趋势 -->
      <div class="chart-card">
        <h3>全期趋势（展现/访客/询盘）</h3>
        <canvas id="trendChart"></canvas>
      </div>
    </div>
  </div>

  <footer>
    数据最后更新：<span class="update" id="lastUpdate">-</span>
  </footer>

  <script>
    Chart.register(ChartDataLabels); // 注册数值显示插件
    let allData = [];
    let currentMonth = '';

    function excelToDate(serial) {
      const utc_days = Math.floor(serial - 25569);
      const date_info = new Date(utc_days * 86400 * 1000);
      return new Date(date_info.getFullYear(), date_info.getMonth(), date_info.getDate());
    }

    async function loadData() {
      try {
        const res = await fetch('data.xlsx?t=' + Date.now());
        if (!res.ok) throw new Error('未找到 data.xlsx');
        const ab = await res.arrayBuffer();
        const wb = XLSX.read(ab, { type: 'array' });
        const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });

        allData = rows.slice(2)
          .filter(r => r[0] && !isNaN(r[0]))
          .map(r => ({
            date: excelToDate(Number(r[0])),
            totalExp: Number(r[1]) || 0,
            adExp: Number(r[2]) || 0,
            naturalExp: Number(r[3]) || 0,
            visitors: Number(r[4]) || 0,
            inquiries: Number(r[5]) || 0,
            reception: Number(r[6]) || 0,
          }))
          .filter(d => d.totalExp > 0 || d.visitors > 0);

        allData.sort((a,b) => a.date - b.date);
        initMonthSelector();
        const latest = allData[allData.length-1].date.toISOString().slice(0,7);
        document.getElementById('monthSelect').value = latest;
        switchMonth(latest);
      } catch (e) {
        document.body.innerHTML += `<h2 style="color:red;text-align:center">加载失败：${e.message}</h2>`;
      }
    }

    function initMonthSelector() {
      const months = [...new Set(allData.map(d => d.date.toISOString().slice(0,7)))].sort();
      const sel = document.getElementById('monthSelect');
      months.forEach(m => {
        const opt = new Option(m, m);
        sel.add(opt);
      });
      sel.onchange = () => switchMonth(sel.value);
    }

    function switchMonth(month) {
      currentMonth = month;
      const data = currentMonth ? allData.filter(d => d.date.toISOString().slice(0,7) === month) : allData;

      const total = data.reduce((a,b) => ({
        totalExp: a.totalExp + b.totalExp,
        visitors: a.visitors + b.visitors,
        inquiries: a.inquiries + b.inquiries,
        reception: a.reception + b.reception,
        adExp: a.adExp + b.adExp,
        naturalExp: a.naturalExp + b.naturalExp
      }), {totalExp:0, visitors:0, inquiries:0, reception:0, adExp:0, naturalExp:0});

      // 更新总览
      document.getElementById('totalExp').textContent = total.totalExp.toLocaleString();
      document.getElementById('totalVis').textContent = total.visitors.toLocaleString();
      document.getElementById('totalInq').textContent = total.inquiries;
      document.getElementById('totalRec').textContent = total.reception;
      document.getElementById('convRate').textContent = total.visitors ? (total.inquiries/total.visitors*100).toFixed(2)+'%' : '0%';
      document.getElementById('adRate').textContent = total.totalExp ? (total.adExp/total.totalExp*100).toFixed(1)+'%' : '0%';
      document.getElementById('lastUpdate').textContent = new Date().toLocaleString('zh-CN');

      // 1. 饼图 + 中心文字
      const adPct = total.totalExp ? (total.adExp/total.totalExp*100).toFixed(1) : 0;
      document.getElementById('pieCenter').textContent = `广告 ${adPct}%`;
      new Chart(document.getElementById('pieChart'), {
        type: 'doughnut',
        data: { datasets: [{ data: [total.adExp, total.naturalExp], backgroundColor: ['#ff00ff', '#00ffff'], borderWidth: 4 }] },
        options: { cutout: '68%', plugins: { legend: { position: 'bottom', labels: { color: '#00ffff' } }, datalabels: { display: false } } }
      });

      // 2. 周询盘&接待 + 中心显示总询盘
      document.getElementById('weeklyTotal').textContent = total.inquiries;
      const weeks = {};
      data.forEach(d => {
        const w = Math.ceil(d.date.getDate() / 7);
        if (!weeks[w]) weeks[w] = { inq: 0, rec: 0 };
        weeks[w].inq += d.inquiries;
        weeks[w].rec += d.reception;
      });
      const labels = Object.keys(weeks).sort((a,b)=>a-b).map(w => `第${w}周`);
      new Chart(document.getElementById('weeklyChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: '周询盘', data: labels.map(w => weeks[w.split('第')[1]].inq), borderColor: '#ff00ff', tension: 0.4 },
            { label: '周接待', data: labels.map(w => weeks[w.split('第')[1]].rec), borderColor: '#00ffff', tension: 0.4 }
          ]
        },
        options: {
          plugins: {
            datalabels: {
              color: '#fff',
              backgroundColor: 'rgba(0,0,0,0.7)',
              borderRadius: 4,
              font: { weight: 'bold' },
              formatter: (value) => value
            }
          }
        },
        plugins: [ChartDataLabels]
      });

      // 3. 月度询盘柱状图顶部数值
      const monthly = {};
      allData.forEach(d => {
        const m = d.date.toISOString().slice(0,7);
        monthly[m] = (monthly[m] || 0) + d.inquiries;
      });
      new Chart(document.getElementById('monthlyChart'), {
        type: 'bar',
        data: {
          labels: Object.keys(monthly).sort(),
          datasets: [{ label: '月询盘总量', data: Object.values(monthly), backgroundColor: '#ff00ff' }]
        },
        options: {
          plugins: {
            datalabels: {
              color: '#00ffff',
              anchor: 'end',
              align: 'top',
              font: { weight: 'bold', size: 16 }
            }
          }
        },
        plugins: [ChartDataLabels]
      });

      // 4. 每日增长热力图显示百分比
      const growth = data.map((d,i) => i===0 ? 0 : ((d.inquiries - data[i-1].inquiries)/Math.max(data[i-1].inquiries,1)*100));
      new Chart(document.getElementById('heatmapChart'), {
        type: 'bar',
        data: {
          labels: data.map(d => d.date.getDate()+'日'),
          datasets: [{
            label: '增长率 %',
            data: growth,
            backgroundColor: growth.map(g => g > 0 ? '#00ff88' : '#ff0066')
          }]
        },
        options: {
          plugins: {
            datalabels: {
              color: '#fff',
              font: { weight: 'bold' },
              formatter: (v) => v === 0 ? '' : (v > 0 ? '+' : '') + v.toFixed(0) + '%'
            }
          }
        },
        plugins: [ChartDataLabels]
      });

      // 5. 漏斗显示数值
      new Chart(document.getElementById('funnelChart'), {
        type: 'bar',
        data: {
          labels: ['总展现', '访客', '询盘', '接待'],
          datasets: [{ data: [total.totalExp, total.visitors, total.inquiries, total.reception], backgroundColor: ['#00ffff','#ff00ff','#ffff00','#00ff88'] }]
        },
        options: {
          indexAxis: 'y',
          plugins: {
            datalabels: { color: '#fff', font: { weight: 'bold', size: 14 } }
          },
          scales: { x: { display: false } }
        },
        plugins: [ChartDataLabels]
      });

      // 6. 全期趋势
      new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
          labels: data.map(d => d.date.getDate()+'日'),
          datasets: [
            { label: '展现', data: data.map(d=>d.totalExp), borderColor: '#00ffff', tension: 0.4 },
            { label: '访客', data: data.map(d=>d.visitors), borderColor: '#ff00ff', tension: 0.4 },
            { label: '询盘', data: data.map(d=>d.inquiries), borderColor: '#ffff00', tension: 0.4 }
          ]
        },
        options: { plugins: { legend: { labels: { color: '#00ffff' } } } }
      });
    }

    loadData();
  </script>
</body>
</html>
